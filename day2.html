<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåø</text></svg>" />
  <title>4 Step Method - Healing Anxiety - Day 2</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="/journey_tracker.js" async></script> <!-- journey_tracker.js included -->
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 50px;
      background-color: #f9f9f9;
      overflow-x: hidden;
      margin: 0;
    }
    .video-wrapper {
      width: 100%;
      margin: 0;
      padding: 0;
    }
    form {
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      max-width: 800px;
      margin: 50px auto;
      text-align: left;
    }
    textarea {
      width: 100%;
      margin-bottom: 20px;
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
      resize: vertical;
    }
    button {
      padding: 12px 25px;
      font-size: 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    .emoji {
      position: absolute;
      font-size: 30px;
      animation: fall linear forwards;
      pointer-events: none;
      z-index: 1000;
    }
    @keyframes fall {
      0% { opacity: 1; transform: translateY(-50px) rotate(0deg); }
      100% { opacity: 0; transform: translateY(100vh) rotate(360deg); }
    }
    .wistia_responsive_padding {
      position: relative;
      width: 100%;
      padding-top: 56.25%;
    }
    .wistia_responsive_wrapper {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
    }
    #successMessageDay2 {
      display: none;
      padding: 20px;
      width: auto;
      min-width: 280px;
      max-width: 90%;
      margin: 30px auto;
      background: #e6ffe6;
      border: 2px solid #4CAF50;
      border-radius: 10px;
      font-size: 16px;
      color: #333;
      text-align: center;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      box-sizing: border-box;
    }
    @media (min-width: 600px) {
      #successMessageDay2 {
        max-width: 500px;
      }
    }
    @media (max-width: 360px) {
      #successMessageDay2 {
        padding: 15px 10px;
        font-size: 15px;
      }
    }
    @media (max-width: 600px) {
      body { padding: 0 !important; }
      .wistia_responsive_padding { padding-top: 125% !important; }
      .wistia_responsive_wrapper, .wistia_embed { height: 100% !important; }
    }
  </style>
</head>

<body>
  <!-- legit_visitor cookie is managed by journey_tracker.js or index.html -->

  <div class="video-wrapper">
    <script src="https://fast.wistia.com/embed/medias/6wzjnv790t.jsonp" async></script>
    <script src="https://fast.wistia.com/assets/external/E-v1.js" async></script>
    <div class="wistia_responsive_padding">
      <div class="wistia_responsive_wrapper">
        <div class="wistia_embed wistia_async_6wzjnv790t videoFoam=true">&nbsp;</div>
      </div>
    </div>
    <script>
      window._wq = window._wq || [];
      _wq.push({
        id: "6wzjnv790t",
        onReady: function(video) {
          video.bind("play", function() {
            const iframe = document.querySelector(".wistia_embed iframe, .wistia_embed video");
            if (iframe?.requestFullscreen) iframe.requestFullscreen();
            else if (iframe?.webkitRequestFullscreen) iframe.webkitRequestFullscreen();
            else if (iframe?.msRequestFullscreen) iframe.msRequestFullscreen();
          });
        }
      });
    </script>
  </div>

  <form id="journalFormDay2" onsubmit="submitJournalDay2(event);">
    <h2>Day 2 Journal: Your Family & Feelings</h2>
    <input type="text" name="website" style="display:none" tabindex="-1" autocomplete="off">
    <!-- Hidden fields will be populated by journey_tracker.js -->
    <input type="hidden" name="user_tracker_id" id="journal_user_tracker_id_day2">
    <input type="hidden" name="v_variable" id="journal_v_variable_day2">
    <input type="hidden" name="email" id="journal_email_day2">
    <input type="hidden" name="current_day" value="day2">

    <label for="growing_up">1. Growing Up: What moments from your childhood do you remember feeling scared or tense at home? How did you feel?</label><br>
    <textarea id="growing_up" name="journal_q1" rows="4" placeholder="I remember feeling tense when... / I felt scared when..."></textarea><br>

    <label for="family_reactions">2. Family Reactions: How did your parents or caregivers act when they were upset? What did they usually do to cope?</label><br>
    <textarea id="family_reactions" name="journal_q2" rows="4" placeholder="My mom would... / My dad would... / My caregiver would..."></textarea><br>

    <label for="insights">3. Insights: What did you learn from today's video about how your past might connect to your anxiety now?</label><br>
    <textarea id="insights" name="journal_q3" rows="4" placeholder="I'm beginning to see how... / I realized that..."></textarea><br>

    <button type="submit">Finish Day 2 & Continue to Day 3</button>
  </form>

  <div id="successMessageDay2">
    ‚úÖ PDF downloaded & Journal Submitted!<br><br>
    Beautiful work today. You're doing the deep healing work that truly matters.<br><br>
    You'll be forwarded to the next module (Day 3) in <span id="countdownDay2">5</span> seconds. üåø‚ú®
  </div>

  <script>
    async function submitJournalDay2(event) {
      event.preventDefault(); // Prevent default form submission

      if (typeof populateJournalFormHiddenFields === "function") {
          console.log("day2.html: Calling populateJournalFormHiddenFields(2) before submission.");
          populateJournalFormHiddenFields(2);
      } else {
          console.error("day2.html: populateJournalFormHiddenFields function is not defined. Ensure journey_tracker.js is loaded.");
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const growing_up = document.getElementById("growing_up").value.trim();
      const family_reactions = document.getElementById("family_reactions").value.trim();
      const insights = document.getElementById("insights").value.trim();

      if (!growing_up || !family_reactions || !insights) {
        alert("‚ö†Ô∏è Please complete all fields before continuing.");
        return;
      }

      doc.setFont("Helvetica", "bold");
      doc.setFontSize(18);
      doc.text("Healing Anxiety Journal ‚Äì Day 2", 105, 20, null, null, "center");
      doc.setFont("Helvetica", "normal");
      doc.setFontSize(12);
      let y = 40;
      function addQuestion(question, answer) {
        if (y > 270) { doc.addPage(); y = 20; }
        doc.setFont("Helvetica", "bold");
        doc.text(question, 10, y); y += 8;
        doc.setFont("Helvetica", "normal");
        let splitText = doc.splitTextToSize(answer || "-", 180);
        doc.text(splitText, 10, y); y += splitText.length * 8 + 10;
      }
      addQuestion("1. Growing Up: What moments from your childhood do you remember feeling scared or tense at home?", growing_up);
      addQuestion("2. Family Reactions: How did your parents or caregivers act when they were upset?", family_reactions);
      addQuestion("3. Insights: What did you learn from today's video about how your past might connect to your anxiety now?", insights);
      
      doc.save("Healing_Anxiety_Journal_Day2.pdf");

      const form = document.getElementById("journalFormDay2");
      const formData = new FormData(form);

      console.log("Form data being sent (day2.html - after explicit population attempt):");
      for (let [key, value] of formData.entries()) {
        console.log(`${key}: ${value}`);
      }

      try {
        const response = await fetch("submit_journal.php", {
          method: "POST",
          body: formData,
        });
        const result = await response.json();

        if (result.success) {
          document.getElementById("successMessageDay2").style.display = "block";
          triggerConfettiDay2();
          let seconds = 5;
          const countdownEl = document.getElementById("countdownDay2");
          countdownEl.textContent = seconds;
          const interval = setInterval(() => {
            seconds--;
            countdownEl.textContent = seconds;
            if (seconds === 0) {
              clearInterval(interval);
              if (result.next_page) {
                window.location.href = result.next_page;
              } else {
                alert("Thank you for your submission!");
              }
            }
          }, 1000);
        } else {
          alert("Error submitting journal: " + (result.message || "Unknown error"));
        }
      } catch (error) {
        console.error("Error submitting journal Day 2:", error);
        alert("An error occurred while submitting your journal. Please try again.");
      }
    }

    function triggerConfettiDay2() {
      const emojis = ["üåø", "‚ú®", "üå∏", "üßò‚Äç‚ôÇÔ∏è", "üåû", "ü™∑", "üçÉ"];
      for (let i = 0; i < 40; i++) {
        const emoji = document.createElement("div");
        emoji.className = "emoji";
        emoji.style.left = Math.random() * 100 + "vw";
        emoji.style.top = "-50px";
        emoji.style.animationDuration = (2 + Math.random() * 3) + "s";
        emoji.innerText = emojis[Math.floor(Math.random() * emojis.length)];
        document.body.appendChild(emoji);
        setTimeout(() => emoji.remove(), 5000);
      }
    }
  </script>
</body>
</html>
